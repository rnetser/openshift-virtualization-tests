# Smoke Tests Label Manager
# Manages 3-label lifecycle based on CodeRabbit analysis
# Created with Claude Code assistance
#
# 3-Label Lifecycle:
# ┌─────────────────────────────────┬──────────────────────────────────────────────────┐
# │ Label                           │ Meaning                                          │
# ├─────────────────────────────────┼──────────────────────────────────────────────────┤
# │ smoke-tests:pending-analysis    │ Waiting for CodeRabbit analysis                  │
# │ smoke-tests:false               │ CodeRabbit determined no smoke tests needed      │
# │ smoke-tests:pending-execution   │ CodeRabbit determined smoke tests needed         │
# └─────────────────────────────────┴──────────────────────────────────────────────────┘
#
# Workflows:
# ┌────────────────┬──────────────────────────────────┬─────────────────────────────────────┐
# │ Trigger        │ Removes                          │ Adds                                │
# ├────────────────┼──────────────────────────────────┼─────────────────────────────────────┤
# │ New PR/Push    │ smoke-tests:false                │ smoke-tests:pending-analysis        │
# │                │ smoke-tests:pending-execution    │                                     │
# ├────────────────┼──────────────────────────────────┼─────────────────────────────────────┤
# │ CodeRabbit NO  │ smoke-tests:pending-analysis     │ smoke-tests:false                   │
# │                │ smoke-tests:pending-execution    │                                     │
# ├────────────────┼──────────────────────────────────┼─────────────────────────────────────┤
# │ CodeRabbit YES │ smoke-tests:pending-analysis     │ smoke-tests:pending-execution       │
# │                │ smoke-tests:false                │                                     │
# └────────────────┴──────────────────────────────────┴─────────────────────────────────────┘

name: "Smoke Tests Label Manager"

on:
  # WARNING: pull_request_target runs with write permissions on base repo
  # Safe here because we only manipulate labels without executing PR code
  # NEVER add steps that checkout or execute code from the PR branch
  pull_request_target:
    types: [opened, synchronize, reopened]
  pull_request_review_comment:
    types: [created, edited]
  issue_comment:
    types: [created, edited]

permissions:
  pull-requests: write
  contents: read

jobs:
  # Flow 1: Reset on push
  reset-on-push:
    name: Reset label on push
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Remove smoke-tests:false and pending-execution
        uses: actions-ecosystem/action-remove-labels@v1
        continue-on-error: true
        with:
          number: ${{ github.event.pull_request.number }}
          labels: |
            smoke-tests:false
            smoke-tests:pending-execution
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Add smoke-tests:pending-analysis
        uses: actions-ecosystem/action-add-labels@v1
        continue-on-error: true
        with:
          number: ${{ github.event.pull_request.number }}
          labels: smoke-tests:pending-analysis
          github_token: ${{ secrets.GITHUB_TOKEN }}

  manage-smoke-tests-label:
    name: Manage label from CodeRabbit
    # Only run for CodeRabbit comments
    if: |
      github.event_name != 'pull_request_target' &&
      (
        (github.event_name == 'issue_comment' &&
         (github.event.comment.user.login == 'coderabbitai' || github.event.comment.user.login == 'coderabbitai[bot]')) ||
        (github.event_name == 'pull_request_review_comment' &&
         (github.event.review_comment.user.login == 'coderabbitai' || github.event.review_comment.user.login == 'coderabbitai[bot]'))
      )
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Determine label action
        id: flow
        env:
          COMMENT_BODY: ${{ github.event_name == 'pull_request_review_comment' && github.event.review_comment.body || github.event.comment.body }}
        run: |
          [ -z "$COMMENT_BODY" ] && { echo "ERROR: Empty comment body"; exit 1; }

          # Strip <details> and <summary> blocks to avoid matching patterns in analysis chain scripts
          COMMENT_STRIPPED=$(printf '%s' "$COMMENT_BODY" | sed -e '/<details>/,/<\/details>/d' -e '/<summary>/,/<\/summary>/d')

          HAS_TEST_PLAN=$(printf '%s' "$COMMENT_STRIPPED" | grep -qF '## Test Execution Plan' && echo "true" || echo "false")
          HAS_RUN_TRUE=$(printf '%s' "$COMMENT_STRIPPED" | grep -qF '**Run smoke tests: True**' && echo "true" || echo "false")
          HAS_RUN_FALSE=$(printf '%s' "$COMMENT_STRIPPED" | grep -qF '**Run smoke tests: False**' && echo "true" || echo "false")

          if [ "$HAS_RUN_TRUE" = "true" ] && [ "$HAS_RUN_FALSE" = "true" ]; then
            echo "ERROR: Comment contains both True and False - ambiguous"
            exit 1
          fi

          FLOW_NO="false"
          FLOW_YES="false"

          if [ "$HAS_TEST_PLAN" = "true" ] && [ "$HAS_RUN_FALSE" = "true" ]; then
            FLOW_NO="true"
          elif [ "$HAS_TEST_PLAN" = "true" ] && [ "$HAS_RUN_TRUE" = "true" ]; then
            FLOW_YES="true"
          fi

          echo "flow_no=$FLOW_NO" >> $GITHUB_OUTPUT
          echo "flow_yes=$FLOW_YES" >> $GITHUB_OUTPUT

      # Flow 2: CodeRabbit says NO
      - name: Remove smoke-tests:pending-analysis and pending-execution (NO flow)
        if: steps.flow.outputs.flow_no == 'true'
        uses: actions-ecosystem/action-remove-labels@v1
        continue-on-error: true
        with:
          number: ${{ github.event.issue.number || github.event.pull_request.number }}
          labels: |
            smoke-tests:pending-analysis
            smoke-tests:pending-execution
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Add smoke-tests:false (NO flow)
        if: steps.flow.outputs.flow_no == 'true'
        uses: actions-ecosystem/action-add-labels@v1
        continue-on-error: true
        with:
          number: ${{ github.event.issue.number || github.event.pull_request.number }}
          labels: smoke-tests:false
          github_token: ${{ secrets.GITHUB_TOKEN }}

      # Flow 3: CodeRabbit says YES
      - name: Remove smoke-tests:pending-analysis and smoke-tests:false (YES flow)
        if: steps.flow.outputs.flow_yes == 'true'
        uses: actions-ecosystem/action-remove-labels@v1
        continue-on-error: true
        with:
          number: ${{ github.event.issue.number || github.event.pull_request.number }}
          labels: |
            smoke-tests:pending-analysis
            smoke-tests:false
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Add smoke-tests:pending-execution (YES flow)
        if: steps.flow.outputs.flow_yes == 'true'
        uses: actions-ecosystem/action-add-labels@v1
        continue-on-error: true
        with:
          number: ${{ github.event.issue.number || github.event.pull_request.number }}
          labels: smoke-tests:pending-execution
          github_token: ${{ secrets.GITHUB_TOKEN }}
