# Generated using Claude cli
# description: Complete CodeRabbit test execution plan lifecycle - request, track, verify
# Handles test plan generation, review iterations, and verification with automatic label management

name: CodeRabbit Test Execution Plan

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  pull_request_target:
    types: [synchronize]

permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  manage-execution-plan:
    runs-on: ubuntu-latest
    steps:
      - name: Acknowledge /generate-execution-plan request
        if: ${{ github.event.comment && contains(github.event.comment.body, '/generate-execution-plan') }}
        uses: peter-evans/create-or-update-comment@v5
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: '+1'

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Run CodeRabbit workflow handler
        env:
          # BOT3_TOKEN has additional permissions needed for:
          # - Organization team membership checks (cnvqe-bot team)
          # - Creating comments on behalf of the bot
          # Fallback to github.token for testing/development only
          GITHUB_TOKEN: ${{ secrets.BOT3_TOKEN || github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_EVENT_ACTION: ${{ github.event.action }}
          GITHUB_PR_NUMBER: "${{ github.event.pull_request.number || github.event.issue.number }}"
          COMMENT_BODY: ${{ github.event.comment.body }}
          REVIEW_BODY: ${{ github.event.review.body }}
          COMMENTER_LOGIN: ${{ github.event.comment.user.login || github.event.review.user.login }}
        run: uv run python .github/scripts/coderabbit_workflow.py
