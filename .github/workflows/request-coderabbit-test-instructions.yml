# Generated using Claude cli
# description: Complete CodeRabbit test execution plan lifecycle - request, track, verify
# Handles test plan generation, review iterations, and verification with automatic label management

name: CodeRabbit Test Execution Plan

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  pull_request_target:
    types: [synchronize]

permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  # Single job that routes to appropriate action based on event context
  manage-execution-plan:
    runs-on: ubuntu-latest
    steps:
      - name: Route and execute action
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BOT3_TOKEN || github.token }}
          script: |
            const eventName = context.eventName;
            const eventAction = context.payload.action;

            console.log(`Event: ${eventName}, Action: ${eventAction}`);

            // ============================================================
            // Helper function: Check team membership
            // ============================================================
            async function isUserInTeam(username) {
              try {
                await github.rest.teams.getMembershipForUserInOrg({
                  org: context.repo.owner,
                  team_slug: 'cnvqe-bot',
                  username: username
                });
                return true;
              } catch (error) {
                return false;
              }
            }

            // ============================================================
            // SCENARIO 1: New commit pushed - Remove labels
            // ============================================================
            if (eventName === 'pull_request_target' && eventAction === 'synchronize') {
              const prNumber = context.payload.pull_request?.number;

              if (!prNumber) {
                console.log('No PR number found, skipping');
                return;
              }

              const labelsToRemove = ['execution-plan-generated', 'execution-plan-passed'];
              console.log(`New commit pushed to PR #${prNumber}, removing execution plan labels`);

              for (const labelName of labelsToRemove) {
                try {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: prNumber,
                    name: labelName
                  });
                  console.log(`Removed label: ${labelName}`);
                } catch (error) {
                  if (error.status !== 404) {
                    throw error;
                  }
                  console.log(`Label not present: ${labelName}`);
                }
              }

              console.log('Execution plan labels removed - test plan needs to be regenerated');
              return;
            }

            // ============================================================
            // For comment-based events, check if it's a PR
            // ============================================================
            if (eventName === 'issue_comment' || eventName === 'pull_request_review_comment' || eventName === 'pull_request_review') {
              const isPullRequest = !!context.payload.pull_request || !!context.payload.issue?.pull_request;

              if (!isPullRequest) {
                console.log('Not a pull request, skipping');
                return;
              }

              const prNumber = context.payload.pull_request?.number || context.payload.issue?.number;
              const commenter = context.payload.comment?.user?.login || context.payload.review?.user?.login;

              console.log(`PR #${prNumber}, Commenter: ${commenter}`);

              // Skip renovate comments
              if (commenter && commenter.includes('renovate')) {
                console.log('Renovate comment, skipping');
                return;
              }

              // ============================================================
              // SCENARIO 2: CodeRabbit posts test execution plan - Add label
              // ============================================================
              if (commenter === 'coderabbitai[bot]') {
                const commentBody = (context.payload.comment?.body || context.payload.review?.body || '').toLowerCase();

                // Check for test execution plan
                if (commentBody.includes('test execution plan verified')) {
                  console.log('CodeRabbit posted verification message');

                  // Remove execution-plan-generated label if it exists
                  try {
                    await github.rest.issues.removeLabel({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: prNumber,
                      name: 'execution-plan-generated'
                    });
                    console.log('Removed execution-plan-generated label');
                  } catch (error) {
                    if (error.status !== 404) {
                      throw error;
                    }
                    console.log('execution-plan-generated label was not present');
                  }

                  // Add execution-plan-passed label
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: prNumber,
                    labels: ['execution-plan-passed']
                  });

                  console.log('Added execution-plan-passed label');
                  return;

                } else if (commentBody.includes('test execution plan')) {
                  console.log('CodeRabbit posted test execution plan');

                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: prNumber,
                    labels: ['execution-plan-generated']
                  });

                  console.log('Added execution-plan-generated label');
                  return;
                }

                console.log('CodeRabbit comment does not contain test execution plan keywords, skipping');
                return;
              }

              // ============================================================
              // SCENARIO 3 & 4: User comments - Request plan or review
              // ============================================================
              const commentBody = (context.payload.comment?.body || context.payload.review?.body || '').toLowerCase();

              // Check for /generate-execution-plan or /verified commands
              const hasGenerateCommand = commentBody.includes('/generate-execution-plan');
              const hasVerifiedCommand = commentBody.includes('/verified');

              console.log(`Has /generate-execution-plan: ${hasGenerateCommand}`);
              console.log(`Has /verified: ${hasVerifiedCommand}`);

              // ============================================================
              // SCENARIO 3: Request initial test execution plan
              // ============================================================
              if (hasGenerateCommand || hasVerifiedCommand) {
                console.log('User requested test execution plan');

                // Check team membership - both commands require team membership
                const isMember = await isUserInTeam(commenter);
                console.log(`User is ${isMember ? '' : 'not '}team member`);

                // Block non-team members from using both commands
                if (!isMember) {
                  console.log(`/${hasGenerateCommand ? 'generate-execution-plan' : 'verified'} is restricted to team members only`);
                  return;
                }

                // Request test execution plan from CodeRabbit
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: `@coderabbitai
                  <details>
                    <summary>Test execution plan request details</summary>

                    CRITICAL: You MUST respond with a review comment on the Files Changed tab, NOT as a regular PR comment.
                    If it cannot be on the 1st line of the 1st file, add it to any other changed file.

                    As an expert software testing engineer, analyze all modified files in this PR and create a targeted test execution plan.
                    You will create a change request comment on the 1st line of the 1st file in the pr with the test execution plan.
                    If you fail to run or post a comment, retry.

                    **Analysis Requirements:**

                    1. Examine code changes in each modified file
                    2. Identify affected code paths, functions, and classes
                    3. Analyze pytest-specific elements: fixtures (scope, dependencies), parametrization, markers, conftest changes
                    4. Trace test dependencies through imports, shared utilities, and fixture inheritance
                    5. Detect new tests introduced in the PR

                    **Your deliverable:**
                    Your change request comment will be based on the following requirements:

                    **Test Execution Plan**

                    - \`path/to/test_file.py\` - When the entire test file needs verification
                    - \`path/to/test_file.py::TestClass::test_method\` - When specific test(s) needed
                    - \`path/to/test_file.py::test_function\` - When specific test(s) needed
                    - \`-m marker\` - When specific marker(s) can be used to cover multiple cases.

                    **Guidelines:**

                    - Include only tests directly affected by the changes
                    - Use a full file path only if ALL tests in that file require verification
                    - Use file path + test name if only specific tests are needed
                    - If a test marker can cover multiple files/tests, provide the marker
                    - Balance coverage vs over-testing - Keep descriptions minimal
                    - Do not add a follow-up comment in the PR, only the change request one. THIS IS IMPORTANT! Spams the PR.

                  </details>`
                });

                console.log('Requested test execution plan from CodeRabbit');

                // For /generate-execution-plan, stop here (don't check for review)
                // For /verified, continue to SCENARIO 4 to also check if review is needed
                if (hasGenerateCommand) {
                  return;
                }
                // /verified falls through to SCENARIO 4
              }

              // ============================================================
              // SCENARIO 4: User responds to test plan - Request review
              // ============================================================
              // Check if execution-plan-generated label exists
              const { data: labels } = await github.rest.issues.listLabelsOnIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber
              });

              const hasGeneratedLabel = labels.some(label => label.name === 'execution-plan-generated');
              const hasPassedLabel = labels.some(label => label.name === 'execution-plan-passed');

              console.log(`Has execution-plan-generated label: ${hasGeneratedLabel}`);
              console.log(`Has execution-plan-passed label: ${hasPassedLabel}`);

              // If both labels exist (invalid state), skip
              if (hasGeneratedLabel && hasPassedLabel) {
                console.log('Both labels exist - invalid state, skipping');
                return;
              }

              // Only proceed if execution-plan-generated label exists
              if (!hasGeneratedLabel) {
                console.log('No execution-plan-generated label, skipping review request');
                return;
              }

              // Check if comment is a response to test plan
              const isRelevantResponse =
                commentBody.includes('test execution plan') ||
                commentBody.includes('@coderabbitai') ||
                hasVerifiedCommand;

              if (!isRelevantResponse) {
                console.log('Comment is not a response to test plan, skipping');
                return;
              }

              // For /verified commands, check team membership (required)
              if (hasVerifiedCommand) {
                const isMember = await isUserInTeam(commenter);
                console.log(`User is ${isMember ? '' : 'not '}team member for /verified in review`);

                // Block non-team members from using /verified
                if (!isMember) {
                  console.log('/verified is restricted to team members only');
                  return;
                }
              }

              console.log('User responded to test plan, requesting CodeRabbit review');

              // Request CodeRabbit to review user response
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `@coderabbitai
                <details>
                  <summary>Test Execution Plan Review Request</summary>

                  The PR author has responded to your test execution plan. Please review their response and determine if:

                  1. **All comments are adequately addressed** - If the author has provided sufficient information or made the requested changes, respond with:
                     \`\`\`
                     Test execution plan verified
                     \`\`\`
                     This will automatically update the PR labels and mark the review as complete.

                  2. **More clarification or changes are needed** - If the response is insufficient or if you need more specific test instructions, provide:
                     - Clear, specific feedback on what's missing
                     - Additional test scenarios that need coverage
                     - Specific test paths or markers that should be included
                     - Any concerns about the proposed test approach

                  **Review Guidelines:**
                  - Focus on whether the proposed tests adequately cover the code changes
                  - Ensure test scope is neither too broad (over-testing) nor too narrow (missing coverage)
                  - Verify that critical code paths have appropriate test coverage
                  - Check if pytest markers, fixtures, or parametrization changes are properly tested

                  **Important:**
                  - For verification: Post "Test execution plan verified" as a **regular PR comment** (not on Files Changed)
                  - For additional feedback/instructions: Use review comments on the Files Changed tab for line-specific guidance
                  - The exact phrase "Test execution plan verified" will trigger automatic label updates
                  - Be specific and actionable in your feedback

                </details>`
              });

              console.log('Requested CodeRabbit to review user response');
              return;
            }

            console.log('No action taken - event does not match any scenario');
